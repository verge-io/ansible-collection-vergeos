---
- name: Import Windows OVA and configure with unattend.xml
  hosts: localhost
  gather_facts: false

  vars:
    vergeos_host: "192.168.1.216"
    vergeos_username: "admin"
    vergeos_password: "password"
    vergeos_insecure: true

    # VM configuration
    vm_name: "win2022-server"
    vm_hostname: "WIN2022-TEST"
    # Option 1: Use file name (recommended)
    ova_file_name: "windowsgold.ova"
    # Option 2: Use file ID directly (if you know it)
    # ova_file_id: "46"

    # Network configuration
    network_name: "External"          # VergeOS network to attach NIC to
    ip_address: "192.168.1.15"
    subnet: "24"
    gateway: "192.168.1.1"
    admin_password: "Password123!"    # Windows Administrator password

    # Unattend.xml content (inline for testing)
    # For production, consider using ansible-vault to encrypt this variable
    unattend_xml_content: |
      <?xml version="1.0" encoding="utf-8"?>
      <unattend xmlns="urn:schemas-microsoft-com:unattend"
                xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State">
        <settings pass="specialize">
          <component name="Microsoft-Windows-Shell-Setup"
                     processorArchitecture="amd64"
                     publicKeyToken="31bf3856ad364e35"
                     language="neutral"
                     versionScope="nonSxS">
            <ComputerName>{{ vm_hostname }}</ComputerName>
          </component>
          <component name="Microsoft-Windows-TCPIP"
                     processorArchitecture="amd64"
                     publicKeyToken="31bf3856ad364e35"
                     language="neutral"
                     versionScope="nonSxS">
            <Interfaces>
              <Interface wcm:action="add">
                <Identifier>Ethernet</Identifier>
                <Ipv4Settings>
                  <DhcpEnabled>false</DhcpEnabled>
                </Ipv4Settings>
                <UnicastIpAddresses>
                  <IpAddress wcm:action="add" wcm:keyValue="1">{{ ip_address }}/{{ subnet }}</IpAddress>
                </UnicastIpAddresses>
                <Routes>
                  <Route wcm:action="add">
                    <Identifier>1</Identifier>
                    <Prefix>0.0.0.0/0</Prefix>
                    <NextHopAddress>{{ gateway }}</NextHopAddress>
                  </Route>
                </Routes>
              </Interface>
            </Interfaces>
          </component>
        </settings>

        <settings pass="oobeSystem">
          <component name="Microsoft-Windows-Shell-Setup"
                     processorArchitecture="amd64"
                     publicKeyToken="31bf3856ad364e35"
                     language="neutral"
                     versionScope="nonSxS">
            <OOBE>
              <HideEULAPage>true</HideEULAPage>
              <NetworkLocation>Work</NetworkLocation>
            </OOBE>
            <UserAccounts>
              <AdministratorPassword>
                <Value>{{ admin_password }}</Value>
                <PlainText>true</PlainText>
              </AdministratorPassword>
            </UserAccounts>
          </component>
        </settings>
      </unattend>

  tasks:
    - name: Import Windows VM from OVA file
      vergeio.vergeos.vm_import:
        host: "{{ vergeos_host }}"
        username: "{{ vergeos_username }}"
        password: "{{ vergeos_password }}"
        insecure: "{{ vergeos_insecure }}"
        ova_file_name: "{{ ova_file_name }}"
        name: "{{ vm_name }}"
        preserve_macs: false
        preferred_tier: "4"
        override_drive_interface: virtio
        override_nic_interface: virtio
        poll_interval: 5
        poll_timeout: 600
      register: import_result

    - name: Display import result
      ansible.builtin.debug:
        msg: |
          ========================================
          Windows VM Import Completed Successfully!
          ========================================
          VM Name: {{ import_result.vm_name | default('N/A (check mode)') }}
          VM ID: {{ import_result.vm_id | default('N/A (check mode)') }}
          Status: {{ import_result.status | default('N/A (check mode)') }}
          Import Key: {{ import_result.import_key | default('N/A (check mode)') }}

    - name: Wait for VM to become fully editable
      ansible.builtin.pause:
        seconds: 5

    - name: Attach NIC to the External network
      vergeio.vergeos.nic:
        host: "{{ vergeos_host }}"
        username: "{{ vergeos_username }}"
        password: "{{ vergeos_password }}"
        insecure: "{{ vergeos_insecure }}"
        vm_name: "{{ vm_name }}"
        network: "{{ network_name }}"
        state: present
        nic_type: virtio
        enabled: true
      register: nic_result

    - name: Display NIC configuration result
      ansible.builtin.debug:
        msg: |
          ========================================
          NIC Configured Successfully!
          ========================================
          VM: {{ vm_name }}
          Network: {{ network_name }}
          NIC Type: virtio
          Status: {{ 'Updated' if nic_result.changed else 'Already exists' }}

    - name: Configure Windows unattend.xml for the imported VM
      vergeio.vergeos.windows_unattend:
        host: "{{ vergeos_host }}"
        username: "{{ vergeos_username }}"
        password: "{{ vergeos_password }}"
        insecure: "{{ vergeos_insecure }}"
        vm_name: "{{ vm_name }}"
        unattend_xml: "{{ unattend_xml_content }}"
      register: unattend_result

    - name: Display unattend.xml configuration result
      ansible.builtin.debug:
        msg: |
          ========================================
          Unattend.xml Configuration Completed!
          ========================================
          VM ID: {{ unattend_result.vm_id | default('N/A (check mode)') }}
          Unattend File Created: /unattend.xml
          Configuration includes:
            - Hostname: {{ vm_hostname }}
            - IP Address: {{ ip_address }}/{{ subnet }}
            - Gateway: {{ gateway }}
            - Administrator Password: [configured]

    - name: Power on the Windows VM
      vergeio.vergeos.vm:
        host: "{{ vergeos_host }}"
        username: "{{ vergeos_username }}"
        password: "{{ vergeos_password }}"
        insecure: "{{ vergeos_insecure }}"
        name: "{{ vm_name }}"
        state: running
      register: vm_power_result

    - name: Display final status
      ansible.builtin.debug:
        msg: |
          ========================================
          Windows VM Successfully Deployed and Started!
          ========================================
          Name: {{ vm_name }}
          Hostname: {{ vm_hostname }}
          IP Address: {{ ip_address }}/{{ subnet }}
          Gateway: {{ gateway }}
          Network: {{ network_name }}

          The Windows VM is now running and will configure itself
          with the specified hostname and network settings using
          the unattend.xml file during first boot.

          IMPORTANT: The VM will reboot automatically during setup.
          Wait 5-10 minutes for the unattend process to complete.

          You can connect to the VM after it completes its setup:
          - RDP to {{ ip_address }}
          - Username: Administrator
          - Password: [as configured]

    - name: Summary of created resources
      ansible.builtin.debug:
        msg: |
          ========================================
          Resource Summary
          ========================================
          VM ID: {{ import_result.vm_id | default('N/A (check mode)') }}
          VM Name: {{ vm_name }}
          Import Key: {{ import_result.import_key | default('N/A (check mode)') }}
          Unattend File: /unattend.xml
          Power State: running

          Next Steps:
          1. Wait 5-10 minutes for Windows setup to complete
          2. Connect via RDP to {{ ip_address }}
          3. Verify hostname: {{ vm_hostname }}
          4. Verify network configuration is correct
